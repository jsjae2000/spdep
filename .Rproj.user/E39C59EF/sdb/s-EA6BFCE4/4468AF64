{
    "collab_server" : "",
    "contents" : "### R code from vignette source 'lat.Rnw'\n# data: NY8_utm18 TCE NY_nb.gal NY8cities Sy_GeoDa1.GAL Sy_GeoDa4.GAL\n###################################################\n### code chunk number 8: lat.Rnw:179-187\n###################################################\nlibrary(rgdal)\nsetwd('.//data')\nNY8 <- readOGR(\".\", \"NY8_utm18\")\nTCE <- readOGR(\".\", \"TCE\")\nlibrary(spdep)\nNY_nb <- read.gal(\"NY_nb.gal\", region.id=row.names(NY8))\ncities <- readOGR(\".\", \"NY8cities\")\n\n\n###################################################\n### code chunk number 9: lat.Rnw:193-210\n###################################################\nplot(NY8, border=\"grey60\", axes=TRUE)\ntext(coordinates(cities), labels=as.character(cities$names), font=2, cex=0.9)\ntext(bbox(NY8)[1,1], bbox(NY8)[2,2], labels=\"a)\", cex=0.8)\nplot(NY8, border=\"grey60\", axes=TRUE)\npoints(TCE, pch=1, cex=0.7)\npoints(TCE, pch=3, cex=0.7)\ntext(coordinates(TCE), labels=as.character(TCE$name), cex=0.7,\n     font=1, pos=c(4,1,4,1,4,4,4,2,3,4,2), offset=0.3)\ntext(bbox(NY8)[1,1], bbox(NY8)[2,2], labels=\"b)\", cex=0.8)\n\n\n###################################################\n### code chunk number 10: lat.Rnw:281-282 (eval = FALSE)\n###################################################\n## vignette(\"nb\", package=\"spdep\")\n\n\n###################################################\n### code chunk number 11: lat.Rnw:310-311\n###################################################\nlibrary(spdep)\n\n\n###################################################\n### code chunk number 13: lat.Rnw:318-319\n###################################################\nsummary(NY_nb)\n\n\n###################################################\n### code chunk number 15: lat.Rnw:333-344\n###################################################\nplot(NY8, border=\"grey60\", axes=TRUE)\nplot(NY_nb, coordinates(NY8), pch=19, cex=0.6, add=TRUE)\n\n\n###################################################\n### code chunk number 16: lat.Rnw:379-382\n###################################################\nSyracuse <- NY8[NY8$AREANAME == \"Syracuse city\",]\nSy0_nb <- subset(NY_nb, NY8$AREANAME == \"Syracuse city\")\nsummary(Sy0_nb)\n\n\n###################################################\n### code chunk number 17: lat.Rnw:408-415\n###################################################\ncoords <- coordinates(Syracuse)\nIDs <- row.names(Syracuse)\nSy8_nb <- knn2nb(knearneigh(coords, k=1), row.names=IDs)\nSy9_nb <- knn2nb(knearneigh(coords, k=2), row.names=IDs)\nSy10_nb <- knn2nb(knearneigh(coords, k=4), row.names=IDs)\ndsts <- unlist(nbdists(Sy8_nb, coords))\nSy11_nb <- dnearneigh(coords, d1=0, d2=0.75*max(dsts), row.names=IDs)\n\n\n###################################################\n### code chunk number 18: lat.Rnw:495-499\n###################################################\nSy0_lw_W <- nb2listw(Sy0_nb)\nSy0_lw_W\nnames(Sy0_lw_W)\nnames(attributes(Sy0_lw_W))\n\n\n###################################################\n### code chunk number 19: lat.Rnw:519-522\n###################################################\n1/rev(range(card(Sy0_lw_W$neighbours)))\nsummary(unlist(Sy0_lw_W$weights))\nsummary(sapply(Sy0_lw_W$weights, sum))\n\n\n###################################################\n### code chunk number 20: lat.Rnw:539-542\n###################################################\nSy0_lw_B <- nb2listw(Sy0_nb, style=\"B\")\nsummary(unlist(Sy0_lw_B$weights))\nsummary(sapply(Sy0_lw_B$weights, sum))\n\n\n###################################################\n### code chunk number 21: lat.Rnw:579-584\n###################################################\ndsts <- nbdists(Sy0_nb, coordinates(Syracuse))\nidw <- lapply(dsts, function(x) 1/(x/1000))\nSy0_lw_idwB <- nb2listw(Sy0_nb, glist=idw, style=\"B\")\nsummary(unlist(Sy0_lw_idwB$weights))\nsummary(sapply(Sy0_lw_idwB$weights, sum))\n\n\n###################################################\n### code chunk number 22: lat.Rnw:590-618\n###################################################\nlibrary(RColorBrewer)\npal <- brewer.pal(9, \"Reds\")\noopar <- par(mfrow=c(1,3), mar=c(1,1,3,1)+0.1)\nz <- t(listw2mat(Sy0_lw_W))\nbrks <- c(0,0.1,0.143,0.167,0.2,0.5,1)\nnbr3 <- length(brks)-3\nimage(1:63, 1:63, z[,ncol(z):1], breaks=brks, col=pal[c(1,(9-nbr3):9)],\n      main=\"W style\", axes=FALSE)\nbox()\nz <- t(listw2mat(Sy0_lw_B))\nimage(1:63, 1:63, z[,ncol(z):1], col=pal[c(1,9)], main=\"B style\", axes=FALSE)\nbox()\nz <- t(listw2mat(Sy0_lw_idwB))\nbrks <- c(0,0.35,0.73,0.93,1.2,2.6)\nnbr3 <- length(brks)-3\nimage(1:63, 1:63, z[,ncol(z):1], breaks=brks, col=pal[c(1,(9-nbr3):9)],\n      main=\"IDW B style\", axes=FALSE)\nbox()\npar(oopar)\n\n\n###################################################\n### code chunk number 24: lat.Rnw:669-671\n###################################################\ntry(Sy0_lw_D1 <- nb2listw(Sy11_nb, style=\"B\"))\n\n\n###################################################\n### code chunk number 25: lat.Rnw:673-675\n###################################################\nSy0_lw_D1 <- nb2listw(Sy11_nb, style=\"B\", zero.policy=TRUE)\nprint(Sy0_lw_D1, zero.policy=TRUE)\n\n\n###################################################\n### code chunk number 26: lat.Rnw:744-746\n###################################################\nSy14_nb <- read.gal(\"Sy_GeoDa1.GAL\")\nisTRUE(all.equal(Sy0_nb, Sy14_nb, check.attributes=FALSE))\n\n\n###################################################\n### code chunk number 27: lat.Rnw:775-777\n###################################################\nSy16_nb <- read.gwt2nb(\"Sy_GeoDa4.GWT\")\nisTRUE(all.equal(Sy10_nb, Sy16_nb, check.attributes=FALSE))\n\n\n###################################################\n### code chunk number 28: lat.Rnw:882-887\n###################################################\nset.seed(987654)\nn <- length(Sy0_nb)\nuncorr_x <- rnorm(n)\nrho <- 0.5\nautocorr_x <- invIrW(Sy0_lw_W, rho) %*% uncorr_x\n\n\n###################################################\n### code chunk number 29: lat.Rnw:893-908\n###################################################\noopar <- par(mfrow=c(1,2), mar=c(4,4,3,2)+0.1)\nplot(uncorr_x, lag(Sy0_lw_W, uncorr_x), xlab=\"\", cex.lab=0.8,\n     ylab=\"spatial lag\", main=\"Uncorrelated random variable\", cex.main=0.8)\nlines(lowess(uncorr_x, lag(Sy0_lw_W, uncorr_x)), lty=2, lwd=2)\nplot(autocorr_x, lag(Sy0_lw_W, autocorr_x),\n     xlab=\"\", ylab=\"\",\n     main=\"Autocorrelated random variable\", cex.main=0.8, cex.lab=0.8)\nlines(lowess(autocorr_x, lag(Sy0_lw_W, autocorr_x)), lty=2, lwd=2)\npar(oopar)\n\n\n###################################################\n### code chunk number 30: lat.Rnw:1060-1063\n###################################################\nmoran.test(uncorr_x, listw=Sy0_lw_W)\nmoran.test(autocorr_x, listw=Sy0_lw_W)\nmoran.test(autocorr_x, listw=nb2listw(Sy9_nb, style=\"W\"))\n\n\n###################################################\n### code chunk number 31: lat.Rnw:1086-1090\n###################################################\net <- coords[,1] - min(coords[,1])\ntrend_x <- uncorr_x + 0.00025 * et\nmoran.test(trend_x, listw=Sy0_lw_W)\nlm.morantest(lm(trend_x ~ et), listw=Sy0_lw_W)\n\n\n###################################################\n### code chunk number 33: lat.Rnw:1239-1241\n###################################################\nK <- moran(NY8$Cases, listw=nb2listw(NY_nb, style=\"B\"), n=length(NY8$Cases), S0=Szero(nb2listw(NY_nb, style=\"B\")))$K\n\n\n###################################################\n### code chunk number 34: lat.Rnw:1262-1263\n###################################################\nmoran.test(NY8$Cases, listw=nb2listw(NY_nb))\n\n\n###################################################\n### code chunk number 35: lat.Rnw:1286-1288\n###################################################\nlw_B <- nb2listw(NY_nb, style=\"B\")\nmoran.test(NY8$Cases, listw=lw_B)\n\n\n###################################################\n### code chunk number 36: lat.Rnw:1316-1317\n###################################################\nmoran.test(NY8$Cases, listw=lw_B, randomisation=FALSE)\n\n\n###################################################\n### code chunk number 37: lat.Rnw:1343-1344\n###################################################\nlm.morantest(lm(Cases ~ 1, NY8), listw=lw_B)\n\n\n###################################################\n### code chunk number 39: lat.Rnw:1378-1379\n###################################################\nlm.morantest.sad(lm(Cases ~ 1, NY8), listw=lw_B)\n\n\n###################################################\n### code chunk number 41: lat.Rnw:1384-1385\n###################################################\nlm.morantest.exact(lm(Cases ~ 1, NY8), listw=lw_B)\n\n\n###################################################\n### code chunk number 42: lat.Rnw:1401-1404\n###################################################\nset.seed(1234)\nbperm <- moran.mc(NY8$Cases, listw=lw_B, nsim=999)\nbperm\n\n\n###################################################\n### code chunk number 43: lat.Rnw:1426-1433\n###################################################\nr <- sum(NY8$Cases)/sum(NY8$POP8)\nrni <- r*NY8$POP8\nCR <- function(var, mle) rpois(length(var), lambda=mle)\nMoranI.pboot <- function(var, i, listw, n, S0, ...) {\n  return(moran(x=var, listw=listw, n=n, S0=S0)$I)\n}\nset.seed(1234)\n\n\n###################################################\n### code chunk number 45: lat.Rnw:1438-1440\n###################################################\nlibrary(boot)\nboot2 <- boot(NY8$Cases, statistic=MoranI.pboot, R=999, sim=\"parametric\",\n              ran.gen=CR, listw=lw_B, n=length(NY8$Cases), S0=Szero(lw_B), mle=rni)\n\n\n###################################################\n### code chunk number 47: lat.Rnw:1445-1446\n###################################################\npnorm((boot2$t0 - mean(boot2$t))/sd(boot2$t[,1]), lower.tail=FALSE)\n\n\n###################################################\n### code chunk number 48: lat.Rnw:1453-1467\n###################################################\noopar <- par(mfrow=c(1,2))\nxlim <- range(c(bperm$res, boot2$t[,1]))\nhist(bperm$res[-length(bperm$res)], main=\"Permutation bootstrap\", xlab=expression(I[std]), xlim=xlim, density=15, angle=45, ylim=c(0,260))\nabline(v=bperm$statistic, lty=2)\nhist(boot2$t, col=rgb(0.4,0.4,0.4), main=\"Parametric bootstrap\", xlab=expression(I[CR]), xlim=xlim, ylim=c(0,260))\nhist(bperm$res[-length(bperm$res)], density=15, angle=45, add=TRUE)\nabline(v=boot2$t0, lty=2)\npar(oopar)\n\n\n###################################################\n### code chunk number 49: lat.Rnw:1487-1488 (eval = FALSE)\n###################################################\n## rni <- fitted(glm(Cases ~ 1 + offset(log(POP8)), data=NY8, family=\"poisson\"))\n\n\n###################################################\n### code chunk number 50: lat.Rnw:1521-1523\n###################################################\nset.seed(1234)\nEBImoran.mc(n=NY8$Cases, x=NY8$POP8, listw=nb2listw(NY_nb, style=\"B\"), nsim=999)\n\n\n###################################################\n### code chunk number 51: lat.Rnw:1557-1558\n###################################################\ncor8 <- sp.correlogram(neighbours=NY_nb, var=NY8$Cases, order=8, method=\"I\", style=\"C\")\n\n\n###################################################\n### code chunk number 52: lat.Rnw:1579-1581\n###################################################\nlibrary(pgirmess)\ncorD <- correlog(coordinates(NY8), NY8$Cases, method=\"Moran\")\n\n\n###################################################\n### code chunk number 53: lat.Rnw:1589-1599\n###################################################\noopar <- par(mfrow=c(1,2))\nplot(cor8, main=\"Contiguity lag orders\")\nplot(corD, main=\"Distance bands\")\npar(oopar)\n\n\n###################################################\n### code chunk number 54: lat.Rnw:1631-1655\n###################################################\noopar <- par(mfrow=c(1,2))\nmsp <- moran.plot(NY8$Cases, listw=nb2listw(NY_nb, style=\"C\"), quiet=TRUE)\ntitle(\"Moran scatterplot\")\ninfl <- apply(msp$is.inf, 1, any)\nx <- NY8$Cases\nlhx <- cut(x, breaks=c(min(x), mean(x), max(x)), labels=c(\"L\", \"H\"), include.lowest=TRUE)\nwx <- lag(nb2listw(NY_nb, style=\"C\"), NY8$Cases)\nlhwx <- cut(wx, breaks=c(min(wx), mean(wx), max(wx)), labels=c(\"L\", \"H\"), include.lowest=TRUE)\nlhlh <- interaction(lhx, lhwx, infl, drop=TRUE)\ncols <- rep(1, length(lhlh))\ncols[lhlh == \"H.L.TRUE\"] <- 2\ncols[lhlh == \"L.H.TRUE\"] <- 3\ncols[lhlh == \"H.H.TRUE\"] <- 4\nplot(NY8, col=brewer.pal(4, \"Accent\")[cols])\nlegend(\"topright\", legend=c(\"None\", \"HL\", \"LH\", \"HH\"), fill=brewer.pal(4, \"Accent\"), bty=\"n\", cex=0.8, y.intersp=0.8)\ntitle(\"Tracts with influence\")\npar(oopar)\n\n\n###################################################\n### code chunk number 55: lat.Rnw:1683-1684 (eval = FALSE)\n###################################################\n## moran.plot(NY8$Cases, listw=nb2listw(NY_nb, style=\"C\"))\n\n\n###################################################\n### code chunk number 56: lat.Rnw:1764-1767\n###################################################\nlm1 <- localmoran(NY8$Cases, listw=nb2listw(NY_nb, style=\"C\"))\nlm2 <- as.data.frame(localmoran.sad(lm(Cases ~ 1, NY8), nb=NY_nb, style=\"C\"))\nlm3 <- as.data.frame(localmoran.exact(lm(Cases ~ 1, NY8), nb=NY_nb, style=\"C\"))\n\n\n###################################################\n### code chunk number 57: lat.Rnw:1777-1783\n###################################################\nr <- sum(NY8$Cases)/sum(NY8$POP8)\nrni <- r*NY8$POP8\nlw <- nb2listw(NY_nb, style=\"C\")\nsdCR <- (NY8$Cases - rni)/sqrt(rni)\nwsdCR <- lag(lw, sdCR)\nI_CR <- sdCR * wsdCR\n\n\n###################################################\n### code chunk number 58: lat.Rnw:1796-1811\n###################################################\nlibrary(RColorBrewer)\ngry <- c(rev(brewer.pal(8, \"Reds\")[1:6]), brewer.pal(6, \"Blues\"))\nNY8$Standard <- lm1[,1]\nNY8$\"Constant_risk\" <- I_CR\n#nms <- match(c(\"Standard\", \"Constant_risk\"), names(NY8))\nspplot(NY8, c(\"Standard\", \"Constant_risk\"), at=c(-2.5,-1.4,-0.6,-0.2,0,0.2,0.6,4,7), col.regions=colorRampPalette(gry)(8))\n\n\n###################################################\n### code chunk number 59: lat.Rnw:1857-1871\n###################################################\nset.seed(1234)\nnsim <- 999\nN <- length(rni)\nsims <- matrix(0, ncol=nsim, nrow=N)\nfor (i in 1:nsim) {\n  y <- rpois(N, lambda=rni)\n  sdCRi <- (y - rni)/sqrt(rni)\n  wsdCRi <- lag(lw, sdCRi)\n  sims[,i] <- sdCRi * wsdCRi \n}\nxrank <- apply(cbind(I_CR, sims), 1, function(x) rank(x)[1])\ndiff <- nsim - xrank\ndiff <- ifelse(diff > 0, diff, 0)\npval <- punif((diff + 1)/(nsim + 1))\n\n\n###################################################\n### code chunk number 60: lat.Rnw:1877-1893\n###################################################\nNY8$Normal <- lm2[,3]\nNY8$Randomisation <- lm1[,5]\nNY8$Saddlepoint <- lm2[,5]\nNY8$Exact <- lm3[,5]\nNY8$Constant_risk <- pval\ngry <- c(rev(brewer.pal(6, \"Reds\")), brewer.pal(6, \"Blues\"))\nspplot(NY8, c(\"Normal\", \"Randomisation\", \"Saddlepoint\", \"Exact\", \"Constant_risk\"), at=c(0,0.01,0.05,0.1,0.9,0.95,0.99,1), col.regions=colorRampPalette(gry)(7))\n\n\n###################################################\n### code chunk number 61: lat.Rnw:1904-1914\n###################################################\nspplot(NY8, c(\"Normal\", \"Exact\", \"Constant_risk\"), xlim=c(405200, 432200), ylim=c(4652700, 4672000), at=c(0,0.01,0.05,0.1,0.9,0.95,0.99,1), col.regions=colorRampPalette(gry)(7))\n\n\n###################################################\n### code chunk number 62: lat.Rnw:2083-2086\n###################################################\nnylm <- lm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8)\nsummary(nylm)\nNY8$lmresid <- residuals(nylm)\n\n\n###################################################\n### code chunk number 64: lat.Rnw:2132-2134\n###################################################\nNYlistw<-nb2listw(NY_nb, style = \"B\")\nlm.morantest(nylm, NYlistw)\n\n\n###################################################\n### code chunk number 65: lat.Rnw:2155-2158\n###################################################\nNYlistwW <- nb2listw(NY_nb, style = \"W\")\naple(residuals(nylm), listw=NYlistwW)\nspautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistwW)$lambda\n\n\n###################################################\n### code chunk number 66: lat.Rnw:2276-2278\n###################################################\nnysar<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistw)\nsummary(nysar)\n\n\n###################################################\n### code chunk number 67: lat.Rnw:2281-2283\n###################################################\nnylam1 <- c(nysar$lambda)\nnylam2 <- c(LR1.spautolm(nysar)$p.value)\n\n\n###################################################\n### code chunk number 68: lat.Rnw:2320-2337\n###################################################\nNY8$sar_trend <- nysar$fit$signal_trend\nNY8$sar_stochastic <- nysar$fit$signal_stochastic\nrds <- colorRampPalette(brewer.pal(8, \"RdBu\"))\ntr_at <- seq(-1, 1.3, length.out=21)\ntr_rds <- rds(sum(tr_at >= 0)*2)[-(1:(sum(tr_at >= 0)-sum(tr_at < 0)))]\ntr_pl <- spplot(NY8, c(\"sar_trend\"), at=tr_at, col=\"transparent\", col.regions=tr_rds, main=list(label=\"Trend\", cex=0.8))\nst_at <- seq(-0.16, 0.39, length.out=21)\nst_rds <- rds(sum(st_at >= 0)*2)[-(1:(sum(st_at >= 0)-sum(st_at < 0)))]\nst_pl <- spplot(NY8, c(\"sar_stochastic\"), at=st_at, col=\"transparent\", col.regions=st_rds, main=list(label=\"Stochastic\", cex=0.8))\nplot(tr_pl, split=c(1,1,2,1), more=TRUE)\nplot(st_pl, split=c(2,1,2,1), more=FALSE)\n\n\n###################################################\n### code chunk number 69: lat.Rnw:2359-2362\n###################################################\nnylmw <- lm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, weights=POP8)\nsummary(nylmw)\nNY8$lmwresid <- residuals(nylmw)\n\n\n###################################################\n### code chunk number 70: lat.Rnw:2378-2394\n###################################################\nlibrary(RColorBrewer)\ngry <- c(rev(brewer.pal(6, \"Reds\")[1:4]), colorRampPalette(brewer.pal(5, \"Blues\"))(9))\nTCEpts <- list(\"sp.points\", TCE, pch=16, col=\"grey5\")\nspplot(NY8, c(\"lmresid\", \"lmwresid\"), sp.layout=list(TCEpts), col.regions=gry, col=\"transparent\", lwd=0.5, at=seq(-2,4.5,0.5))\n\n\n###################################################\n### code chunk number 71: lat.Rnw:2403-2404\n###################################################\nlm.morantest(nylmw, NYlistw)\n\n\n###################################################\n### code chunk number 72: lat.Rnw:2423-2425\n###################################################\nnysarw<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME , data=NY8, listw=NYlistw, weights=POP8)\nsummary(nysarw)\n\n\n###################################################\n### code chunk number 73: lat.Rnw:2443-2455\n###################################################\nNY8$sarw_trend <- nysarw$fit$signal_trend\nNY8$sarw_stochastic <- nysarw$fit$signal_stochastic\ntr_pl <- spplot(NY8, c(\"sarw_trend\"), at=tr_at, col=\"transparent\", col.regions=tr_rds, main=list(label=\"Trend\", cex=0.8))\nst_pl <- spplot(NY8, c(\"sarw_stochastic\"), at=st_at, col=\"transparent\", col.regions=st_rds, main=list(label=\"Stochastic\", cex=0.8))\nplot(tr_pl, split=c(1,1,2,1), more=TRUE)\nplot(st_pl, split=c(2,1,2,1), more=FALSE)\n\n\n###################################################\n### code chunk number 74: lat.Rnw:2510-2513\n###################################################\nnycar<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME , data=NY8, family=\"CAR\",\n                listw=NYlistw)\nsummary(nycar)\n\n\n###################################################\n### code chunk number 75: lat.Rnw:2516-2517\n###################################################\nnylam1 <- c(nycar$lambda)\n\n\n###################################################\n### code chunk number 76: lat.Rnw:2548-2551\n###################################################\nnycarw<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, family=\"CAR\",\n                 listw=NYlistw, weights=POP8)\nsummary(nycarw)\n\n\n###################################################\n### code chunk number 77: lat.Rnw:2624-2626\n###################################################\nnysarwM<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, family=\"SAR\",\n                  listw=NYlistw, weights=POP8, method=\"Matrix\")\n\n\n###################################################\n### code chunk number 78: lat.Rnw:2628-2629\n###################################################\nsummary(nysarwM)\n\n\n###################################################\n### code chunk number 79: lat.Rnw:2659-2664\n###################################################\n1/range(eigenw(NYlistw))\nnysar_ll<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, family=\"SAR\",\n                   listw=NYlistw, llprof=100)\nnysarw_ll<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, family=\"SAR\",\n                    listw=NYlistw, weights=POP8, llprof=100)\n\n\n###################################################\n### code chunk number 80: lat.Rnw:2670-2684\n###################################################\nylim <- range(c(nysarw_ll$llprof$ll, nysar_ll$llprof$ll), na.rm=TRUE)\nplot(nysarw_ll$llprof$lambda, nysarw_ll$llprof$ll, type=\"l\", xlab=expression(lambda), ylab=\"log likelihood\", ylim=ylim, lwd=2)\nabline(v=nysarw_ll$lambda)\nabline(h=nysarw_ll$LL)\nlines(nysar_ll$llprof$lambda, nysar_ll$llprof$ll, lty=2, lwd=2)\nabline(v=nysar_ll$lambda, lty=2)\nabline(h=nysar_ll$LL, lty=2)\nlegend(\"bottom\", legend=c(\"weighted SAR\", \"SAR\"), lty=c(1,2), lwd=2, bty=\"n\")\n\n\n###################################################\n### code chunk number 81: lat.Rnw:2711-2714\n###################################################\nnysmaw<-spautolm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, family=\"SMA\",\n                 listw=NYlistw, weights=POP8)\nsummary(nysmaw)\n\n\n###################################################\n### code chunk number 82: lat.Rnw:2752-2754\n###################################################\nlibrary(lmtest)\nbptest(nylm)\n\n\n###################################################\n### code chunk number 83: lat.Rnw:2776-2779\n###################################################\nlibrary(sandwich)\ncoeftest(nylm)\ncoeftest(nylm, vcov=vcovHC(nylm, type=\"HC4\"))\n\n\n###################################################\n### code chunk number 84: lat.Rnw:2813-2818\n###################################################\nNYlistwW <- nb2listw(NY_nb, style = \"W\")\nres <- lm.LMtests(nylm, listw=NYlistwW, test=\"all\")\ntres <- t(sapply(res, function(x) c(x$statistic, x$parameter, x$p.value)))\ncolnames(tres) <- c(\"Statistic\", \"df\", \"p-value\")\nprintCoefmat(tres)\n\n\n###################################################\n### code chunk number 85: lat.Rnw:2901-2904\n###################################################\nnylag <- lagsarlm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistwW)\nsummary(nylag)\nbptest.sarlm(nylag)\n\n\n###################################################\n### code chunk number 86: lat.Rnw:2942-2943\n###################################################\nlibrary(McSpatial)\n\n\n###################################################\n### code chunk number 87: lat.Rnw:2945-2947\n###################################################\nMcRes <- sarml(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, wmat=listw2mat(NYlistwW), eigvar=eigenw(NYlistwW), print=FALSE, data=NY8)\nc(McRes$beta, rho=McRes$rho, sig2=McRes$sig2)\n\n\n###################################################\n### code chunk number 88: lat.Rnw:2963-2966\n###################################################\nnymix <- lagsarlm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistwW, type=\"mixed\")\nnymix\nanova(nymix, nylag)\n\n\n###################################################\n### code chunk number 89: lat.Rnw:3048-3051\n###################################################\nW <- as(as_dgRMatrix_listw(NYlistwW), \"CsparseMatrix\")\ntrMat <- trW(W, type=\"mult\")\nhead(trMat)\n\n\n###################################################\n### code chunk number 90: lat.Rnw:3088-3094\n###################################################\nset.seed(987654)\nimps <- impacts(nymix, tr=trMat, R=1999)\nimps\nlibrary(coda)\nHPDinterval(imps, choice=\"direct\")\nHPDinterval(imps, choice=\"indirect\")\nHPDinterval(imps, choice=\"total\")\n\n\n###################################################\n### code chunk number 91: lat.Rnw:3130-3133\n###################################################\nnyerr <- errorsarlm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistwW)\nsummary(nyerr)\nLR.sarlm(nyerr, nymix)\n\n\n###################################################\n### code chunk number 92: lat.Rnw:3153-3155\n###################################################\nnyerr1 <- errorsarlm(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistwW, etype=\"emixed\")\ncoef(nyerr1)\n\n\n###################################################\n### code chunk number 93: lat.Rnw:3186-3188\n###################################################\nset.seed(987654)\nresMCMC <- MCMCsamp(nyerr1, mcmc=5000, burnin=500, listw=NYlistwW)\n\n\n###################################################\n### code chunk number 94: lat.Rnw:3197-3213\n###################################################\noopar <- par(mfrow=c(1, 2), mar=c(3, 3, 3, 1))\nplot(density(resMCMC[,3]), ylab=\"\", main=\"Direct\", xlab=\"\", lwd=2)\nlines(density(imps$sres$direct[,1]), lty=2, lwd=2)\nabline(v=0)\nplot(density(resMCMC[,6]), ylab=\"\", main=\"Indirect\", xlab=\"\", lwd=2)\nlines(density(imps$sres$indirect[,1]), lty=2, lwd=2)\nabline(v=0)\nlegend(\"topright\", legend=c(\"Error Durbin\", \"Durbin\"), lty=1:2, bty=\"n\", lwd=c(2, 2), cex=0.7)\npar(oopar)\n\n\n###################################################\n### code chunk number 95: lat.Rnw:3243-3244\n###################################################\nlibrary(sphet)\n\n\n###################################################\n### code chunk number 96: lat.Rnw:3246-3248\n###################################################\nnyGMlag <- spreg(Z ~ PEXPOSURE + PCTAGE65P + PCTOWNHOME, data=NY8, listw=NYlistwW, model=\"lag\", het=FALSE)\nsummary(nyGMlag)\n\n\n###################################################\n### code chunk number 97: lat.Rnw:3264-3266\n###################################################\nnyGMerr <- spreg(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, data=NY8, listw=NYlistwW, model=\"error\", het=FALSE)\nsummary(nyGMerr)\n\n\n###################################################\n### code chunk number 98: lat.Rnw:3287-3288\n###################################################\nfit <- qregspiv(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME, wmat=listw2mat(NYlistwW), data=NY8, tau=.5, nboot=200)\n\n\n###################################################\n### code chunk number 99: lat.Rnw:3347-3352\n###################################################\nlibrary(mgcv)\nNY8$x<-coordinates(NY8)[,1]/1000\nNY8$y<-coordinates(NY8)[,2]/1000\nnyGAM1 <- gam(Z~PEXPOSURE+PCTAGE65P+PCTOWNHOME+s(x,y), weights=POP8, data=NY8)\nanova(nylmw, nyGAM1, test=\"Chisq\")\n\n\n###################################################\n### code chunk number 100: lat.Rnw:3355-3356\n###################################################\nnylam1 <- c(summary(nyGAM1)$edf)\n\n\n###################################################\n### code chunk number 102: lat.Rnw:3401-3402\n###################################################\nnyGLMp <- glm(Cases~PEXPOSURE+PCTAGE65P+PCTOWNHOME+offset(log(POP8)), data=NY8, family=\"poisson\")\n\n\n###################################################\n### code chunk number 103: lat.Rnw:3404-3405 \n###################################################\nsummary(nyGLMp)\n\n\n###################################################\n### code chunk number 106: lat.Rnw:3421-3436\n###################################################\nlibrary(RColorBrewer)\nNY8$lmpresid <- residuals(nyGLMp, type=\"deviance\")\ngry <- c(rev(brewer.pal(6, \"Reds\")), brewer.pal(7, \"Blues\"))\nTCEpts <- list(\"sp.points\", TCE, pch=16, col=\"grey5\")\nspplot(NY8, \"lmpresid\", sp.layout=list(TCEpts), col.regions=gry, col=\"transparent\", lwd=0.5, at=seq(-3,3.5,0.5))\n\n\n###################################################\n### code chunk number 108: lat.Rnw:3464-3466\n###################################################\nnyGAMp <- gam(Cases~PEXPOSURE+PCTAGE65P+PCTOWNHOME+offset(log(POP8))+s(x,y), data=NY8, family=\"poisson\")\nsummary(nyGAMp)\n\n\n###################################################\n### code chunk number 109: lat.Rnw:3468-3469 \n###################################################\nanova(nyGLMp, nyGAMp, test=\"Chisq\")\n\n\n###################################################\n### code chunk number 111: lat.Rnw:3479-3481\n###################################################\nnylam1 <- c(summary(nyGAMp)$edf)\n\n",
    "created" : 1488552494657.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "585014590",
    "id" : "4468AF64",
    "lastKnownWriteTime" : 1488555860,
    "last_content_update" : 1488555860807,
    "path" : "C:/spdep/lagmodel.R",
    "project_path" : "lagmodel.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}